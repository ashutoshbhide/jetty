<html><head>
      <meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
   <title>Quality of Service Filter</title><link rel="stylesheet" type="text/css" href="css/docbook.css"><meta name="generator" content="DocBook XSL-NS Stylesheets V1.76.1"><meta name="keywords" content="jetty, servlet-api, cometd, http, spdy, eclipse, maven, java, software"><link rel="home" href="index.html" title="Jetty : The Definitive Reference"><link rel="up" href="advanced-extras.html" title="Chapter&nbsp;19.&nbsp;Bundled Servlets, Filters, and Handlers"><link rel="prev" href="cgi-servlet.html" title="CGI Servlet"><link rel="next" href="dos-filter.html" title="Denial of Service Filter"><link xmlns:jfetch="java:org.eclipse.jetty.xslt.tools.JavaSourceFetchExtension" xmlns:fetch="java:org.eclipse.jetty.xslt.tools.SourceFetchExtension" xmlns:d="http://docbook.org/ns/docbook" xmlns:l="http://docbook.sourceforge.net/xmlns/l10n/1.0" xmlns:xslthl="http://xslthl.sf.net" rel="shortcut icon" href="images/favicon.ico"></head><body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF"><center xmlns:jfetch="java:org.eclipse.jetty.xslt.tools.JavaSourceFetchExtension" xmlns:fetch="java:org.eclipse.jetty.xslt.tools.SourceFetchExtension" xmlns:d="http://docbook.org/ns/docbook" xmlns:l="http://docbook.sourceforge.net/xmlns/l10n/1.0" xmlns:xslthl="http://xslthl.sf.net"><a href="http://www.eclipse.org/jetty"><img src="images/jetty-header-logo.png" alt="Jetty Logo"></a></center><div class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="3" align="center">Quality of Service Filter</th></tr><tr><td width="20%" align="left"><a accesskey="p" href="cgi-servlet.html">Prev</a>&nbsp;</td><th width="60%" align="center">Chapter&nbsp;19.&nbsp;Bundled Servlets, Filters, and Handlers</th><td width="20%" align="right">&nbsp;<a accesskey="n" href="dos-filter.html">Next</a></td></tr></table><hr></div><div xmlns:jfetch="java:org.eclipse.jetty.xslt.tools.JavaSourceFetchExtension" xmlns:fetch="java:org.eclipse.jetty.xslt.tools.SourceFetchExtension" xmlns:d="http://docbook.org/ns/docbook" xmlns:l="http://docbook.sourceforge.net/xmlns/l10n/1.0" xmlns:xslthl="http://xslthl.sf.net" class="jetty-callout"><h5 class="callout"><a href="http://www.webtide.com/support.jsp">Contact the core Jetty developers at
          <span class="website">www.webtide.com</span></a></h5><p>
 private support for your internal/customer projects ... custom extensions and distributions ... versioned snapshots for indefinite support ...
 scalability guidance for your apps and Ajax/Comet projects ... development services from 1 day to full product delivery
      </p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="qos-filter"></a>Quality of Service Filter</h2></div></div></div><div class="toc"><dl><dt><span class="section"><a href="qos-filter.html#qos-understanding">Understanding the Problem</a></span></dt><dt><span class="section"><a href="qos-filter.html#qos-applying">Applying the QoSFilter</a></span></dt></dl></div><p>
    Jetty supports Continuations, which allow non-blocking handling of HTTP requests, so that threads can be allocated in a managed way to provide application specific Quality of Service (QoS). The QoSFilter is a utility servlet filter that implements some QoS features.
  </p><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="qos-understanding"></a>Understanding the Problem</h3></div></div></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="d0e9952"></a>Waiting for Resources</h4></div></div></div><p>
        Web applications frequently use JDBC Connection pools to limit the simultaneous load on the database. This protects the database from peak loads, but makes the web application vulnerable to thread starvation. Consider a thread pool with 20 connections, being used by a web application that that typically receives 200 requests per second and each request holds a JDBC connection for 50ms. Such a pool can service on average 200*20*1000/50 = 400 requests per second.
      </p><p>
        However, if the request rate rises above 400 per second, or if the database slows down (due to a large query) or becomes momentarily unavailable, the thread pool can very quickly accumulate many waiting requests. If, for example, the website is slashdotted or experiences some other temporary burst of traffic and the request rate rises from 400 to 500 requests per second, then 100 requests per second join those waiting for a JDBC connection. Typically, a web server's thread pool contains only a few hundred threads, so a burst or slow DB need only persist for a few seconds to consume the entire web server's thread pool. This is called thread starvation. The key issue with thread starvation is that it effects the entire web application, and potentially the entire web server. Even if the requests using the database are only a small proportion of the total requests on the web server, all requests are blocked because all the available threads are waiting on the JDBC connection pool. This represents non graceful degradation under load and provides a very poor quality of service.
      </p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="d0e9959"></a>Prioritizing Resources</h4></div></div></div><p>
        Consider a web application that is under extreme load. This load might be due to a popularity spike (slashdot), usage burst (Christmas or close of business), or even a denial of service attack. During such periods of load, it is often desirable not to treat all requests as equals, and to give priority to high value customers or administrative users.
      </p><p>
        The typical behaviour of a web server under extreme load is to use all its threads to service requests and to build up a backlog of unserviced requests. If the backlog grows deep enough, then requests start to timeout and users experience failures as well as delays.
      </p><p>
        Ideally, the web application should be able to examine the requests in the backlog, and give priority to high value customers and administrative users. But with the standard blocking servlet API, it is not possible to examine a request without allocating a thread to that request for the duration of its handling. There is no way to delay the handling of low priority requests, so if the resources are to be reallocated, then the low priority requests must all be failed.
      </p></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="qos-applying"></a>Applying the QoSFilter</h3></div></div></div><p>
      The Quality of Service Filter (QoSFilter) uses Continuations to avoid thread starvation, prioritize requests and give graceful degradation under load, to provide a high quality of service. When you apply the filter to specific URLs within a web application, it limits the number of active requests being handled for those URLs. Any requests in excess of the limit are suspended. When a request completes handling the limited URL, one of the waiting requests resumes and can be handled. You can assign priorities to each suspended request, so that high priority requests resume before lower prority requests.
    </p><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="d0e9973"></a>Required JARs</h4></div></div></div><p>
        To use the QoS Filter, these JAR files must be available in WEB-INF/lib:
      </p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem"><p>
            $JETTY_HOME/lib/ext/jetty-util.jar
          </p></li><li class="listitem"><p>
            $JETTY_HOME/lib/ext/jetty-servlets.jar&#8211;contains QoSFilter
          </p></li></ul></div></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="d0e9985"></a>Sample Configuration</h4></div></div></div><p>
        Place the configuration in a webapp's web.xml or jetty-web.xml The default configuration processes ten requests at a time, servicing more important requests first, and queuing up the rest. This example processes fifty requests at a time:
      </p><div class="informalexample"><pre class="programlisting">

<strong class="hl-tag" style="color: #000096">&lt;filter&gt;</strong>
   <strong class="hl-tag" style="color: #000096">&lt;filter-name&gt;</strong>QoSFilter<strong class="hl-tag" style="color: #000096">&lt;/filter-name&gt;</strong>
   <strong class="hl-tag" style="color: #000096">&lt;filter-class&gt;</strong>org.eclipse.jetty.servlets.QoSFilter<strong class="hl-tag" style="color: #000096">&lt;/filter-class&gt;</strong>
   <strong class="hl-tag" style="color: #000096">&lt;init-param&gt;</strong>
     <strong class="hl-tag" style="color: #000096">&lt;param-name&gt;</strong>maxRequests<strong class="hl-tag" style="color: #000096">&lt;/param-name&gt;</strong>
     <strong class="hl-tag" style="color: #000096">&lt;param-value&gt;</strong>50<strong class="hl-tag" style="color: #000096">&lt;/param-value&gt;</strong>
   <strong class="hl-tag" style="color: #000096">&lt;/init-param&gt;</strong>
 <strong class="hl-tag" style="color: #000096">&lt;/filter&gt;</strong>
 
        </pre></div></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="d0e9993"></a>Configuring QoS Filter Parameters</h4></div></div></div><p>
        A semaphore polices the "maxRequests" limit. The filter waits a short time while attempting to acquire the semaphore. The "waitMs" init parameter controls the wait, avoiding the expense of a suspend if the semaphore is shortly available. If the semaphore cannot be obtained, Jetty suspends the request for the default suspend period of the container or the value set as the "suspendMs" init parameter.
      </p><p>
        The QoS filter uses the following init parameters:
      </p><div class="variablelist"><dl><dt><span class="term">maxRequests</span></dt><dd><p>
              the maximum number of requests to be serviced at a time. The default is 10.
            </p></dd><dt><span class="term">maxPriority</span></dt><dd><p>
              the maximum valid priority that can be assigned to a request. A request with a high priority value is more important than a request with a low priority value. The default is 10.
            </p></dd><dt><span class="term">waitMS</span></dt><dd><p>
              waitMS&#8211;length of time, in milliseconds, to wait while trying to accept a new request. Used when the maxRequests limit is reached. Default is 50 ms.
            </p></dd><dt><span class="term">suspendMS</span></dt><dd><p>
              length of time, in milliseconds, that the request will be suspended if it is not accepted immediately. If not set, the container's default suspend period applies. Default is -1 ms.
            </p></dd><dt><span class="term">managedAttr</span></dt><dd><p>
              If set to true, then this servlet is set as a ServletContext attribute with the filter name as the attribute name. This allows a context external mechanism (for example, JMX via ContextHandler.MANAGED_ATTRIBUTES) to manage the configuration of the filter.
            </p></dd></dl></div></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="d0e10031"></a>Mapping to URLs</h4></div></div></div><p>
        You can use the <code class="code">&lt;filter-mapping&gt;</code> syntax to map the QoSFilter to a servlet, either by using the servlet name, or by using a URL pattern. In this example, a URL pattern applies the QoSFilter to every request within the web application context:
      </p><div class="informalexample"><pre class="programlisting">
    
<strong class="hl-tag" style="color: #000096">&lt;filter-mapping&gt;</strong>
   <strong class="hl-tag" style="color: #000096">&lt;filter-name&gt;</strong>QoSFilter<strong class="hl-tag" style="color: #000096">&lt;/filter-name&gt;</strong>
   <strong class="hl-tag" style="color: #000096">&lt;url-pattern&gt;</strong>/*<strong class="hl-tag" style="color: #000096">&lt;/url-pattern&gt;</strong>
 <strong class="hl-tag" style="color: #000096">&lt;/filter-mapping&gt;</strong>
 
        </pre></div></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="d0e10042"></a>Setting the Request Priority</h4></div></div></div><p>
        Requests with higher values have a higher priority. The default request priorities assigned by the QoSFilter are:
      </p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem"><p>
            2 -- For any authenticated request
          </p></li><li class="listitem"><p>
            1 -- For any request with a non-new valid session
          </p></li><li class="listitem"><p>
            0 -- For all other requests
          </p></li></ul></div><p>
        To customize the priority, subclass QoSFilter and then override the getPriority(ServletRequest request) method to return an appropriate priority for the request. You can then use this subclass as your QoS filter. Here's a trivial example:
      </p><div class="informalexample"><pre class="programlisting">
    
<span xmlns:jfetch="java:org.eclipse.jetty.xslt.tools.JavaSourceFetchExtension" xmlns:fetch="java:org.eclipse.jetty.xslt.tools.SourceFetchExtension" xmlns:d="http://docbook.org/ns/docbook" xmlns:l="http://docbook.sourceforge.net/xmlns/l10n/1.0" xmlns:xslthl="http://xslthl.sf.net" class="hl-keyword">public</span> <span xmlns:jfetch="java:org.eclipse.jetty.xslt.tools.JavaSourceFetchExtension" xmlns:fetch="java:org.eclipse.jetty.xslt.tools.SourceFetchExtension" xmlns:d="http://docbook.org/ns/docbook" xmlns:l="http://docbook.sourceforge.net/xmlns/l10n/1.0" xmlns:xslthl="http://xslthl.sf.net" class="hl-keyword">class</span> ParsePriorityQoSFilter <span xmlns:jfetch="java:org.eclipse.jetty.xslt.tools.JavaSourceFetchExtension" xmlns:fetch="java:org.eclipse.jetty.xslt.tools.SourceFetchExtension" xmlns:d="http://docbook.org/ns/docbook" xmlns:l="http://docbook.sourceforge.net/xmlns/l10n/1.0" xmlns:xslthl="http://xslthl.sf.net" class="hl-keyword">extends</span> QoSFilter
 {
     <span xmlns:jfetch="java:org.eclipse.jetty.xslt.tools.JavaSourceFetchExtension" xmlns:fetch="java:org.eclipse.jetty.xslt.tools.SourceFetchExtension" xmlns:d="http://docbook.org/ns/docbook" xmlns:l="http://docbook.sourceforge.net/xmlns/l10n/1.0" xmlns:xslthl="http://xslthl.sf.net" class="hl-keyword">protected</span> <span xmlns:jfetch="java:org.eclipse.jetty.xslt.tools.JavaSourceFetchExtension" xmlns:fetch="java:org.eclipse.jetty.xslt.tools.SourceFetchExtension" xmlns:d="http://docbook.org/ns/docbook" xmlns:l="http://docbook.sourceforge.net/xmlns/l10n/1.0" xmlns:xslthl="http://xslthl.sf.net" class="hl-keyword">int</span> getPriority(ServletRequest request)
     {
         String p = ((HttpServletRequest)request).getParameter(<span xmlns:jfetch="java:org.eclipse.jetty.xslt.tools.JavaSourceFetchExtension" xmlns:fetch="java:org.eclipse.jetty.xslt.tools.SourceFetchExtension" xmlns:d="http://docbook.org/ns/docbook" xmlns:l="http://docbook.sourceforge.net/xmlns/l10n/1.0" xmlns:xslthl="http://xslthl.sf.net" class="hl-string">"priority"</span>);
         <span xmlns:jfetch="java:org.eclipse.jetty.xslt.tools.JavaSourceFetchExtension" xmlns:fetch="java:org.eclipse.jetty.xslt.tools.SourceFetchExtension" xmlns:d="http://docbook.org/ns/docbook" xmlns:l="http://docbook.sourceforge.net/xmlns/l10n/1.0" xmlns:xslthl="http://xslthl.sf.net" class="hl-keyword">if</span> (p!=null)
             <span xmlns:jfetch="java:org.eclipse.jetty.xslt.tools.JavaSourceFetchExtension" xmlns:fetch="java:org.eclipse.jetty.xslt.tools.SourceFetchExtension" xmlns:d="http://docbook.org/ns/docbook" xmlns:l="http://docbook.sourceforge.net/xmlns/l10n/1.0" xmlns:xslthl="http://xslthl.sf.net" class="hl-keyword">return</span> Integer.parseInt(p);
         <span xmlns:jfetch="java:org.eclipse.jetty.xslt.tools.JavaSourceFetchExtension" xmlns:fetch="java:org.eclipse.jetty.xslt.tools.SourceFetchExtension" xmlns:d="http://docbook.org/ns/docbook" xmlns:l="http://docbook.sourceforge.net/xmlns/l10n/1.0" xmlns:xslthl="http://xslthl.sf.net" class="hl-keyword">return</span> <span class="hl-number">0</span>;
     }
 }

        </pre></div></div></div></div><div class="navfooter"><hr><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="cgi-servlet.html">Prev</a>&nbsp;</td><td width="20%" align="center"><a accesskey="u" href="advanced-extras.html">Up</a></td><td width="40%" align="right">&nbsp;<a accesskey="n" href="dos-filter.html">Next</a></td></tr><tr><td width="40%" align="left" valign="top">CGI Servlet&nbsp;</td><td width="20%" align="center"><a accesskey="h" href="index.html">Home</a></td><td width="40%" align="right" valign="top">&nbsp;Denial of Service Filter</td></tr></table></div><div xmlns:jfetch="java:org.eclipse.jetty.xslt.tools.JavaSourceFetchExtension" xmlns:fetch="java:org.eclipse.jetty.xslt.tools.SourceFetchExtension" xmlns:d="http://docbook.org/ns/docbook" xmlns:l="http://docbook.sourceforge.net/xmlns/l10n/1.0" xmlns:xslthl="http://xslthl.sf.net" class="jetty-callout"><p>
        See an error or something missing?
        <span class="callout"><a href="http://github.com/jetty-project/jetty-documentation">Contribute to this documentation at
            <span class="website">Github!</span></a></span></p></div><script xmlns:jfetch="java:org.eclipse.jetty.xslt.tools.JavaSourceFetchExtension" xmlns:fetch="java:org.eclipse.jetty.xslt.tools.SourceFetchExtension" xmlns:d="http://docbook.org/ns/docbook" xmlns:l="http://docbook.sourceforge.net/xmlns/l10n/1.0" xmlns:xslthl="http://xslthl.sf.net" type="text/javascript">
  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-1149868-7']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();
    </script></body></html>